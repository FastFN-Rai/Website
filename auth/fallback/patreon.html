<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>リダイレクト中...</title>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="module" src="/js/firebase.js"></script>
  </head>
  <body>
    <h1>リダイレクト中...</h1>
    <script async defer type="module">
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
      import {
        getFirestore,
        addDoc,
        collection,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

      const auth = getAuth();
      const db = getFirestore();
      onAuthStateChanged(auth, async (user) => {
        fetch("http://35.226.102.192:3000/patreon/get-access-token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            code: window.location.href
              .split("?")[1]
              .split("=")[1]
              .split("&")[0],
          }),
        })
          .then((response) => response.json())
          .then(async (resToken) => {
            console.info("[PATREON] Access Token:", resToken.access_token);
            const accessToken = resToken.access_token;

            fetch("http://35.226.102.192:3000/patreon/get-user-info", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                accessToken: accessToken,
              }),
            }).then(async (res) => {
              console.log(res);
              const data = res;
              const dataString = JSON.stringify(data);
              if (dataString.includes("8393641") && dataString.includes("is_monthly")) {
                console.log("Patron")
                const patreonLinkData = await addDoc(
                  collection(db, "patreonlinkstatus-" + user.uid),
                  {
                    linked: true,
                    is_active: true,
                    verifiedOwner: false
                  }
                );
                //location.href = "/auth/panel.html";
              } else {
                console.log("Not a patron")
                const patreonLinkData = await addDoc(
                  collection(db, "patreonlinkstatus-" + user.uid),
                  {
                    linked: true,
                    is_active: false,
                    verifiedOwner: false
                  }
                );

                //location.href = "/auth/panel.html";
              }
            });
          });
      });
    </script>
  </body>
</html>
