<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>リダイレクト中...</title>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="module" src="/js/firebase.js"></script>
  </head>
  <body>
    <h1>リダイレクト中...</h1>
    <script async defer type="module">
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
      import {
        getFirestore,
        addDoc,
        collection,
      } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

      const auth = getAuth();
      const db = getFirestore();
      onAuthStateChanged(auth, async (user) => {
        fetch(
          "https://www.patreon.com/api/oauth2/token?code=" +
            window.location.href.split("?")[1].split("=")[1].split("&")[0] +
            "&grant_type=authorization_code&client_id=yKTcSFN-9G6eAUiu31dOcpGPaCfzhgEulQZ8B8oVgCqTuz_n1K4JPTNy5VF0wY5i&client_secret=oY6kFXPg7dVR6ybPXAYjO3z7Dq3W-8h0-kVqhOwxX2FeQEdHJqBec63FS8GRiZFr&redirect_uri=https://uplauncher.xyz/auth/fallback/patreon.html",
          {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          }
        ).then(async (res2) => {
          fetch("https://patreon.com/api/oauth2/v2/campaigns/8393641/members", {
            mode: "no-cors",
            headers: {
              Authorization: "Bearer " + res2.data.access_token,
            },
          }).then(async (res) => {
            const data = res.data;
            if (data.data.attributes.patron_status === "active_patron") {
              const patreonLinkData = await addDoc(
                collection(db, "patreonlinkstatus-" + user.uid),
                {
                  linked: true,
                  is_active: true,
                }
              );
              location.href = "/auth/panel.html";
            } else {
              const patreonLinkData = await addDoc(
                collection(db, "patreonlinkstatus-" + user.uid),
                {
                  linked: false,
                  is_active: false,
                }
              );

              location.href = "/auth/panel.html";
            }
          });
        });
      });
    </script>
  </body>
</html>
